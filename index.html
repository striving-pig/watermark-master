<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watermark Master Pro - 专业批量加水印</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
<style>
:root {
    --primary: #2563eb;
    --primary-hover: #1d4ed8;
    --danger: #ef4444;
    --danger-hover: #dc2626;
    --bg-main: #f1f5f9;
    --bg-card: #ffffff;
    --text-main: #1e293b;
    --text-muted: #64748b;
    --border: #e2e8f0;
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    --radius: 12px;
}

body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background-color: var(--bg-main);
    color: var(--text-main);
    margin: 0;
    padding: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
}

/* Header Styling */
header {
    background: #0f172a;
    color: white;
    padding: 1rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: var(--shadow-md);
}

header h1 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 700;
    letter-spacing: -0.025em;
    display: flex;
    align-items: center;
    gap: 10px;
}

header h1 svg {
    width: 24px;
    height: 24px;
    fill: var(--primary);
}

/* Layout Grid */
.app-container {
    display: grid;
    grid-template-columns: 320px 1fr 340px;
    gap: 1rem;
    padding: 1rem;
    flex: 1;
    min-height: 0;
}

/* Sidebar Styling */
.sidebar {
    background: var(--bg-card);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 1.25rem;
    overflow-y: auto;
    box-shadow: var(--shadow-sm);
}

.sidebar h2 {
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    margin: 0 0 1rem 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Form Controls */
.control-group {
    margin-bottom: 1.5rem;
}

label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: var(--text-main);
}

input[type="text"],
select {
    width: 100%;
    padding: 0.625rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 0.875rem;
    transition: all 0.2s;
    box-sizing: border-box;
}

input[type="text"]:focus,
select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

/* Range Input Styling */
.range-container {
    display: flex;
    align-items: center;
    gap: 12px;
}

input[type="range"] {
    flex: 1;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    appearance: none;
    cursor: pointer;
}

input[type="range"]::-webkit-slider-thumb {
    appearance: none;
    width: 16px;
    height: 16px;
    background: var(--primary);
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: var(--shadow-sm);
}

.value-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    background: var(--bg-main);
    padding: 2px 6px;
    border-radius: 4px;
    min-width: 55px;
    text-align: center;
}

/* Fieldset Styling */
fieldset {
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1rem;
    margin: 0 0 1rem 0;
    background: #f8fafc;
}

legend {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--primary);
    padding: 0 8px;
}

/* Button Styling */
button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 0.625rem 1rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
}

.btn-primary {
    background-color: var(--primary);
    color: white;
    width: 100%;
}

.btn-primary:hover {
    background-color: var(--primary-hover);
    transform: translateY(-1px);
}

.btn-secondary {
    background-color: white;
    border: 1px solid var(--border);
    color: var(--text-main);
}

.btn-secondary:hover:not(:disabled) {
    background-color: #f8fafc;
    border-color: var(--text-muted);
}

.btn-danger {
    background-color: #fee2e2;
    color: var(--danger);
    border: 1px solid #fecaca;
}

.btn-danger:hover:not(:disabled) {
    background-color: var(--danger);
    color: white;
}

button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Canvas Area */
.canvas-editor {
    display: flex;
    flex-direction: column;
    background: #e2e8f0;
    border-radius: var(--radius);
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
}

.canvas-toolbar {
    background: white;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.canvas-wrapper {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    overflow: hidden;
}

#watermarkCanvas {
    max-width: 100%;
    max-height: 100%;
    background: #fff;
    box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
    border-radius: 4px;
    cursor: grab;
    transition: box-shadow 0.3s;
}

#watermarkCanvas:hover {
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1), 0 20px 25px -5px rgb(0 0 0 / 0.1);
}

#watermarkCanvas.dragging {
    cursor: grabbing;
}

/* Thumbnail List */
.image-thumbnails {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 8px;
    margin-top: 1rem;
}

.thumbnail-item {
    position: relative;
    aspect-ratio: 1/1;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.2s;
    background: #eee;
}

.thumbnail-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.thumbnail-item.selected {
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
}

.thumbnail-checkbox {
    position: absolute;
    top: 4px;
    left: 4px;
    width: 18px;
    height: 18px;
    cursor: pointer;
    z-index: 10;
}

/* Preset Custom List */
.preset-list {
    border: 1px solid var(--border);
    border-radius: 8px;
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: 0.75rem;
    background: #f8fafc;
}

.preset-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.625rem 0.75rem;
    cursor: pointer;
    border-bottom: 1px solid var(--border);
    transition: all 0.2s;
}

.preset-item:last-child {
    border-bottom: none;
}

.preset-item:hover {
    background: #f1f5f9;
}

.preset-item.active {
    background: #e2e8f0;
    font-weight: 600;
    color: var(--primary);
}

.preset-name {
    flex: 1;
    font-size: 0.875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.preset-delete-icon {
    opacity: 0;
    color: var(--danger);
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s;
}

.preset-item:hover .preset-delete-icon {
    opacity: 1;
}

.preset-delete-icon:hover {
    background: #fee2e2;
}

/* Watermark Type Selector */
.type-selector {
    display: flex;
    background: #f1f5f9;
    padding: 4px;
    border-radius: 8px;
    margin-bottom: 1.5rem;
}

.type-selector label {
    flex: 1;
    margin: 0;
    padding: 8px;
    text-align: center;
    font-size: 0.75rem;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s;
}

.type-selector input {
    display: none;
}

.type-selector label:has(input:checked) {
    background: white;
    color: var(--primary);
    box-shadow: var(--shadow-sm);
    font-weight: 600;
}

/* Image Preview Box */
.image-preview {
    width: 100%;
    aspect-ratio: 16/9;
    background: #f8fafc;
    border: 2px dashed var(--border);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 10px;
}

.image-preview img {
    max-width: 90%;
    max-height: 90%;
    object-fit: contain;
}

/* Toggle Switch */
.switch-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
}

.switch {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 20px;
}

.switch input { opacity: 0; width: 0; height: 0; }

.slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #cbd5e1;
    transition: .4s;
    border-radius: 20px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 16px; width: 16px;
    left: 2px; bottom: 2px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider { background-color: var(--primary); }
input:checked + .slider:before { transform: translateX(20px); }

/* Responsive */
@media (max-width: 1100px) {
    .app-container { grid-template-columns: 1fr 1fr; }
    .canvas-editor { grid-column: span 2; order: -1; height: 50vh; }
}

@media (max-width: 768px) {
    .app-container { grid-template-columns: 1fr; }
    .canvas-editor { grid-column: auto; height: 40vh; }
}
</style>
</head>
<body>

<header>
    <h1>
        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>
        Watermark Master Pro
    </h1>
    <div style="font-size: 0.75rem; opacity: 0.8;">V2.4 Interaction Pro</div>
</header>

<div class="app-container">
    <aside class="sidebar resources">
        <h2>
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            待处理图片
        </h2>
        <div class="control-group">
            <input type="file" id="imageUpload" multiple accept="image/*" style="display: none;">
            <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 0.5rem;">
                <button class="btn-secondary" style="width: 100%; margin-bottom: 0.5rem;" onclick="document.getElementById('imageUpload').click()">
                    上传图片
                </button>
                <div id="selectionActions" style="display: flex; gap: 8px; margin-top: -0.5rem;">
                    <button id="deselectAllBtn" class="btn-secondary" style="flex: 1; display: none;">
                        取消选中
                    </button>
                    <button id="deleteSelectedBtn" class="btn-danger" style="flex: 1; display: none;">
                        删除选中
                    </button>
                </div>
            </div>
            <p style="font-size: 0.7rem; color: var(--text-muted); margin: 0;">提示：可直接 Ctrl+V 粘贴图片</p>
            <div id="uploadedImages" class="image-thumbnails"></div>
        </div>

        <h2 style="margin-top: 1rem;">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
            配置预设
        </h2>
        <p style="font-size: 0.75rem; color: var(--text-muted); margin: -0.5rem 0 1rem 0;">单击选中项即可应用预设</p>
        <div class="control-group">
            <div id="presetList" class="preset-list">
                <!-- JS Inserted -->
            </div>
            <button id="savePresetBtn" class="btn-secondary" style="width: 100%;">存为新预设</button>
        </div>

        <div style="margin-top: auto;">
            <button id="exportAllBtn" class="btn-primary" disabled>
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                开始批量导出
            </button>
        </div>
    </aside>

    <section class="canvas-editor">
        <div class="canvas-toolbar">
            <span style="font-size: 0.75rem; color: var(--text-muted); font-weight: 600;">实时编辑预览</span>
            <span id="interactionHint" style="font-size: 0.7rem; background: #e2e8f0; padding: 2px 6px; border-radius: 4px;">点击上传图片</span>
        </div>
        <div class="canvas-wrapper">
            <canvas id="watermarkCanvas"></canvas>
        </div>
    </section>

    <aside class="sidebar settings">
        <h2>
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1行 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            水印参数设置
        </h2>
        
        <div class="type-selector">
            <label><input type="radio" name="watermarkType" value="text" checked> 文字水印</label>
            <label><input type="radio" name="watermarkType" value="image"> 图片水印</label>
        </div>

        <fieldset id="textWatermarkOptions">
            <legend>文字属性</legend>
            <label>水印内容</label>
            <input type="text" id="watermarkText" value="Watermark Master">

            <label style="margin-top: 1rem;">字体族</label>
            <select id="fontSelect">
                <option value="'Inter', sans-serif">Inter (默认)</option>
                <option value="'JetBrains Mono', monospace">JetBrains Mono</option>
                <option value="Arial, sans-serif">Arial</option>
                <option value="Microsoft YaHei, sans-serif">微软雅黑</option>
            </select>

            <label style="margin-top: 1rem;">基本大小</label>
            <div class="range-container">
                <input type="range" id="fontSize" min="10" max="200" value="40">
                <span class="value-badge" id="fontSizeValue">40px</span>
            </div>

            <label style="margin-top: 1rem;">填充颜色</label>
            <input type="color" id="fontColor" value="#ffffff" style="height: 38px; border: none; padding: 2px;">
        </fieldset>

        <fieldset id="imageWatermarkOptions" style="display: none;">
            <legend>图像属性</legend>
            <label>上传水印图</label>
            <input type="file" id="watermarkImageUpload" accept="image/*">
            <div id="watermarkImagePreview" class="image-preview"></div>
        </fieldset>

        <fieldset>
            <legend>通用调整与平铺</legend>
            
            <div class="switch-container">
                <label style="margin-bottom:0">开启全屏平铺</label>
                <label class="switch">
                    <input type="checkbox" id="tilingToggle">
                    <span class="slider"></span>
                </label>
            </div>

            <div id="tileSpacingOptions" style="display: none; border-top: 1px solid #e2e8f0; padding-top: 1rem; margin-top: 0.5rem;">
                <label>水平间距 (px)</label>
                <div class="range-container">
                    <input type="range" id="tileSpacingX" min="200" max="800" value="400">
                    <span class="value-badge" id="tileSpacingXValue">400px</span>
                </div>
                <label style="margin-top: 1rem;">垂直间距 (px)</label>
                <div class="range-container">
                    <input type="range" id="tileSpacingY" min="200" max="800" value="300">
                    <span class="value-badge" id="tileSpacingYValue">300px</span>
                </div>
            </div>

            <label style="margin-top: 1rem;">透明度</label>
            <div class="range-container">
                <input type="range" id="opacitySlider" min="0" max="1" step="0.01" value="0.5">
                <span class="value-badge" id="opacityValue">50%</span>
            </div>

            <label style="margin-top: 1rem;">缩放比例</label>
            <div class="range-container">
                <input type="range" id="sizeSlider" min="0.1" max="5" step="0.1" value="0.5">
                <span class="value-badge" id="sizeValue">50%</span>
            </div>

            <label style="margin-top: 1rem;">旋转角度</label>
            <div class="range-container">
                <input type="range" id="rotationSlider" min="0" max="360" value="0">
                <span class="value-badge" id="rotationValue">0°</span>
            </div>

            <label style="margin-top: 1rem;">位置偏移 X</label>
            <div class="range-container">
                <input type="range" id="positionXSlider" min="0" max="100" value="50">
                <span class="value-badge" id="positionXValue">50%</span>
            </div>

            <label style="margin-top: 1rem;">位置偏移 Y</label>
            <div class="range-container">
                <input type="range" id="positionYSlider" min="0" max="100" value="50">
                <span class="value-badge" id="positionYValue">50%</span>
            </div>
            
            <button id="resetPositionBtn" class="btn-secondary" style="width: 100%; margin-top: 1rem; font-size: 0.75rem;">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v1m0 14v1m8-8h-1M5 12H4m12.728-4.243l-.707.707M6.979 17.021l-.707.707m10.607 0l-.707-.707M6.272 6.272l.707.707M12 12a3 3 0 100-6 3 3 0 000 6z"/></svg>
                重置水印位置
            </button>
        </fieldset>
    </aside>
</div>

<script>
    // --- DOM Elements ---
    const imageUploadInput = document.getElementById('imageUpload');
    const uploadedImagesContainer = document.getElementById('uploadedImages');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    const watermarkCanvas = document.getElementById('watermarkCanvas');
    const interactionHint = document.getElementById('interactionHint');
    const ctx = watermarkCanvas.getContext('2d');
    const exportAllBtn = document.getElementById('exportAllBtn');

    const watermarkTypeRadios = document.querySelectorAll('input[name="watermarkType"]');
    const textWatermarkOptions = document.getElementById('textWatermarkOptions');
    const imageWatermarkOptions = document.getElementById('imageWatermarkOptions');

    const watermarkTextInput = document.getElementById('watermarkText');
    const fontSelect = document.getElementById('fontSelect');
    const fontSizeSlider = document.getElementById('fontSize');
    const fontSizeValue = document.getElementById('fontSizeValue');
    const fontColorInput = document.getElementById('fontColor');

    const watermarkImageUploadInput = document.getElementById('watermarkImageUpload');
    const watermarkImagePreview = document.getElementById('watermarkImagePreview');

    const tilingToggle = document.getElementById('tilingToggle');
    const tileSpacingOptions = document.getElementById('tileSpacingOptions');
    const tileSpacingX = document.getElementById('tileSpacingX');
    const tileSpacingXValue = document.getElementById('tileSpacingXValue');
    const tileSpacingY = document.getElementById('tileSpacingY');
    const tileSpacingYValue = document.getElementById('tileSpacingYValue');

    const opacitySlider = document.getElementById('opacitySlider');
    const opacityValue = document.getElementById('opacityValue');
    const sizeSlider = document.getElementById('sizeSlider');
    const sizeValue = document.getElementById('sizeValue');
    const rotationSlider = document.getElementById('rotationSlider');
    const rotationValue = document.getElementById('rotationValue');
    const positionXSlider = document.getElementById('positionXSlider');
    const positionXValue = document.getElementById('positionXValue');
    const positionYSlider = document.getElementById('positionYSlider');
    const positionYValue = document.getElementById('positionYValue');

    const presetList = document.getElementById('presetList');
    const savePresetBtn = document.getElementById('savePresetBtn');
    const resetPositionBtn = document.getElementById('resetPositionBtn');

    // --- State ---
    let uploadedImages = []; 
    let currentImage = null; 
    let selectedImageIds = new Set();
    let currentPresetIndex = -1;

    let watermark = {
        type: 'text', 
        text: 'Watermark Master',
        font: "'Inter', sans-serif",
        fontSize: 40,
        fontColor: '#ffffff',
        image: null, 
        imageDataUrl: '', 
        opacity: 0.5,
        scale: 0.5, 
        rotation: 0, 
        x: 0.5, 
        y: 0.5,
        isTiled: false,
        tileSpacingX: 400, 
        tileSpacingY: 300, 
        renderedWidth: 0,
        renderedHeight: 0,
        isDragging: false
    };

    let presets = []; 

    const LOCAL_STORAGE_KEY_PRESETS = 'watermarkMasterPresets';
    const LOCAL_STORAGE_KEY_SETTINGS = 'watermarkMasterCurrentSettings';

    // --- Helper Functions ---
    function generateUniqueId() { return '_' + Math.random().toString(36).substr(2, 9); }
    function debounce(func, delay) {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func(...args), delay);
        };
    }

    // --- Core Methods ---
    function saveSettings() {
        const toSave = { ...watermark };
        delete toSave.image;
        localStorage.setItem(LOCAL_STORAGE_KEY_SETTINGS, JSON.stringify({
            watermark: toSave,
            currentImageId: currentImage ? currentImage.id : null
        }));
    }

    function loadSettings() {
        const stored = localStorage.getItem(LOCAL_STORAGE_KEY_SETTINGS);
        if (stored) {
            const data = JSON.parse(stored);
            Object.assign(watermark, data.watermark);
            if (watermark.imageDataUrl) {
                const img = new Image();
                img.onload = () => {
                    watermark.image = img;
                    watermarkImagePreview.innerHTML = `<img src="${watermark.imageDataUrl}">`;
                    updateUI();
                    drawCanvas();
                };
                img.src = watermark.imageDataUrl;
            }
            updateUI();
            return data.currentImageId;
        }
        return null;
    }

    function updateUI() {
        watermarkTextInput.value = watermark.text;
        fontSelect.value = watermark.font;
        fontSizeSlider.value = watermark.fontSize;
        fontSizeValue.textContent = `${watermark.fontSize}px`;
        fontColorInput.value = watermark.fontColor;

        tilingToggle.checked = watermark.isTiled;
        tileSpacingOptions.style.display = watermark.isTiled ? 'block' : 'none';
        tileSpacingX.value = watermark.tileSpacingX;
        tileSpacingXValue.textContent = `${watermark.tileSpacingX}px`;
        tileSpacingY.value = watermark.tileSpacingY;
        tileSpacingYValue.textContent = `${watermark.tileSpacingY}px`;

        opacitySlider.value = watermark.opacity;
        opacityValue.textContent = `${Math.round(watermark.opacity * 100)}%`;
        sizeSlider.value = watermark.scale;
        sizeValue.textContent = `${Math.round(watermark.scale * 100)}%`;
        rotationSlider.value = watermark.rotation;
        rotationValue.textContent = `${watermark.rotation}°`;
        positionXSlider.value = Math.round(watermark.x * 100);
        positionXValue.textContent = `${Math.round(watermark.x * 100)}%`;
        positionYSlider.value = Math.round(watermark.y * 100);
        positionYValue.textContent = `${Math.round(watermark.y * 100)}%`;

        watermarkTypeRadios.forEach(r => r.checked = r.value === watermark.type);
        toggleWatermarkTypeUI(watermark.type === 'text');
        
        exportAllBtn.disabled = uploadedImages.length === 0;
        
        const hasSelection = selectedImageIds.size > 0;
        deleteSelectedBtn.style.display = hasSelection ? 'inline-flex' : 'none';
        deselectAllBtn.style.display = hasSelection ? 'inline-flex' : 'none';

        // 更新提示语
        interactionHint.textContent = currentImage ? '抓取拖动 · 双击空白上传' : '点击区域上传图片';
    }

    function toggleWatermarkTypeUI(isText) {
        textWatermarkOptions.style.display = isText ? 'block' : 'none';
        imageWatermarkOptions.style.display = isText ? 'none' : 'block';
    }

    function renderPresetList() {
        presetList.innerHTML = '';
        if (presets.length === 0) {
            presetList.innerHTML = '<div style="padding:1rem; text-align:center; color:var(--text-muted); font-size:0.8rem;">暂无预设</div>';
            return;
        }
        presets.forEach((p, idx) => {
            const item = document.createElement('div');
            item.className = `preset-item ${currentPresetIndex === idx ? 'active' : ''}`;
            item.innerHTML = `
                <span class="preset-name">${p.name}</span>
                <span class="preset-delete-icon" title="删除预设">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                </span>
            `;
            item.onclick = (e) => {
                if (e.target.closest('.preset-delete-icon')) {
                    deletePreset(idx);
                } else {
                    applyPreset(idx);
                }
            };
            presetList.appendChild(item);
        });
    }

    function deletePreset(idx) {
        if (confirm('确定要删除这个预设吗？')) {
            presets.splice(idx, 1);
            if (currentPresetIndex === idx) currentPresetIndex = -1;
            else if (currentPresetIndex > idx) currentPresetIndex--;
            localStorage.setItem(LOCAL_STORAGE_KEY_PRESETS, JSON.stringify(presets));
            renderPresetList();
        }
    }

    function applyPreset(idx) {
        const p = presets[idx];
        if (p) {
            currentPresetIndex = idx;
            const oldImg = watermark.image;
            const oldUrl = watermark.imageDataUrl;
            Object.assign(watermark, JSON.parse(JSON.stringify(p.settings)));
            if (watermark.imageDataUrl && watermark.imageDataUrl !== oldUrl) {
                const img = new Image();
                img.onload = () => { watermark.image = img; updateUI(); drawCanvas(); renderPresetList(); };
                img.src = watermark.imageDataUrl;
                watermarkImagePreview.innerHTML = `<img src="${watermark.imageDataUrl}">`;
            } else {
                watermark.image = oldImg;
                updateUI(); drawCanvas(); renderPresetList();
            }
        }
    }

    function drawSingleWatermark(targetCtx, x, y) {
        targetCtx.save();
        targetCtx.globalAlpha = watermark.opacity;
        targetCtx.translate(x, y);
        targetCtx.rotate(watermark.rotation * Math.PI / 180);

        if (watermark.type === 'text') {
            targetCtx.font = `${watermark.fontSize * watermark.scale}px ${watermark.font}`;
            targetCtx.fillStyle = watermark.fontColor;
            targetCtx.textAlign = 'center';
            targetCtx.textBaseline = 'middle';
            targetCtx.fillText(watermark.text, 0, 0);
            
            if (targetCtx === ctx) {
                const m = targetCtx.measureText(watermark.text);
                watermark.renderedWidth = m.width;
                watermark.renderedHeight = (m.actualBoundingBoxAscent + m.actualBoundingBoxDescent) || (watermark.fontSize * watermark.scale);
            }
        } else if (watermark.type === 'image' && watermark.image) {
            const w = watermark.image.naturalWidth * watermark.scale;
            const h = watermark.image.naturalHeight * watermark.scale;
            targetCtx.drawImage(watermark.image, -w/2, -h/2, w, h);
            if (targetCtx === ctx) {
                watermark.renderedWidth = w;
                watermark.renderedHeight = h;
            }
        }
        targetCtx.restore();
    }

    function drawCanvas() {
        if (!currentImage) {
            watermarkCanvas.width = watermarkCanvas.parentElement.offsetWidth || 400;
            watermarkCanvas.height = watermarkCanvas.width / (16/9);
            ctx.fillStyle = '#f1f5f9';
            ctx.fillRect(0, 0, watermarkCanvas.width, watermarkCanvas.height);
            ctx.fillStyle = '#94a3b8';
            ctx.font = '14px Inter';
            ctx.textAlign = 'center';
            ctx.fillText('请先上传或选择一张图片 (点击此处)', watermarkCanvas.width/2, watermarkCanvas.height/2);
            return;
        }

        watermarkCanvas.width = currentImage.imgElement.naturalWidth;
        watermarkCanvas.height = currentImage.imgElement.naturalHeight;
        ctx.drawImage(currentImage.imgElement, 0, 0);

        if (watermark.isTiled) {
            const stepX = watermark.tileSpacingX;
            const stepY = watermark.tileSpacingY;
            const offsetX = (watermark.x * watermarkCanvas.width) % stepX;
            const offsetY = (watermark.y * watermarkCanvas.height) % stepY;

            for (let x = offsetX - stepX; x < watermarkCanvas.width + stepX; x += stepX) {
                for (let y = offsetY - stepY; y < watermarkCanvas.height + stepY; y += stepY) {
                    drawSingleWatermark(ctx, x, y);
                }
            }
        } else {
            drawSingleWatermark(ctx, watermark.x * watermarkCanvas.width, watermark.y * watermarkCanvas.height);
        }
        saveSettings();
    }

    // --- Image Handlers ---
    async function processFiles(files) {
        for (const file of files) {
            if (!file.type.startsWith('image/')) continue;
            const reader = new FileReader();
            reader.onload = async (event) => {
                const img = new Image();
                img.src = event.target.result;
                await new Promise(r => img.onload = r);
                const id = generateUniqueId();
                uploadedImages.push({ id, name: file.name || 'pasted-image.png', dataUrl: event.target.result, imgElement: img });
                renderUploadedImages();
                if (!currentImage) selectImage(id);
            };
            reader.readAsDataURL(file);
        }
    }

    async function handleImageUpload(e) {
        processFiles(Array.from(e.target.files));
        e.target.value = '';
    }

    function renderUploadedImages() {
        uploadedImagesContainer.innerHTML = '';
        uploadedImages.forEach(img => {
            const container = document.createElement('div');
            container.className = `thumbnail-item ${currentImage?.id === img.id ? 'selected' : ''}`;
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'thumbnail-checkbox';
            checkbox.checked = selectedImageIds.has(img.id);
            checkbox.onclick = (e) => {
                e.stopPropagation();
                if (checkbox.checked) selectedImageIds.add(img.id);
                else selectedImageIds.delete(img.id);
                updateUI();
            };

            const image = document.createElement('img');
            image.src = img.dataUrl;
            
            container.onclick = () => selectImage(img.id);
            container.appendChild(checkbox);
            container.appendChild(image);
            uploadedImagesContainer.appendChild(container);
        });
        exportAllBtn.disabled = uploadedImages.length === 0;
        updateUI();
    }

    function selectImage(id) {
        currentImage = uploadedImages.find(i => i.id === id);
        renderUploadedImages();
        drawCanvas();
    }

    function deleteSelectedImages() {
        if (selectedImageIds.size === 0) return;
        if (confirm(`确定要删除选中的 ${selectedImageIds.size} 张图片吗？`)) {
            uploadedImages = uploadedImages.filter(img => !selectedImageIds.has(img.id));
            if (currentImage && selectedImageIds.has(currentImage.id)) {
                currentImage = uploadedImages.length > 0 ? uploadedImages[0] : null;
            }
            selectedImageIds.clear();
            renderUploadedImages();
            drawCanvas();
        }
    }
    
    function deselectAllImages() {
        selectedImageIds.clear();
        renderUploadedImages();
    }

    function handleWatermarkImageUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                watermark.image = img;
                watermark.imageDataUrl = event.target.result;
                watermarkImagePreview.innerHTML = `<img src="${event.target.result}">`;
                drawCanvas();
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    }

    async function exportAll() {
        if (!uploadedImages.length) return;
        exportAllBtn.disabled = true;
        const btnText = exportAllBtn.innerHTML;
        exportAllBtn.textContent = '导出中...';

        const tempCanvas = document.createElement('canvas');
        const tCtx = tempCanvas.getContext('2d');

        for (const img of uploadedImages) {
            tempCanvas.width = img.imgElement.naturalWidth;
            tempCanvas.height = img.imgElement.naturalHeight;
            tCtx.drawImage(img.imgElement, 0, 0);

            if (watermark.isTiled) {
                const stepX = watermark.tileSpacingX;
                const stepY = watermark.tileSpacingY;
                const offsetX = (watermark.x * tempCanvas.width) % stepX;
                const offsetY = (watermark.y * tempCanvas.height) % stepY;
                for (let x = offsetX - stepX; x < tempCanvas.width + stepX; x += stepX) {
                    for (let y = offsetY - stepY; y < tempCanvas.height + stepY; y += stepY) {
                        drawSingleWatermark(tCtx, x, y);
                    }
                }
            } else {
                drawSingleWatermark(tCtx, watermark.x * tempCanvas.width, watermark.y * tempCanvas.height);
            }

            const a = document.createElement('a');
            a.href = tempCanvas.toDataURL('image/png');
            a.download = `wm_${img.name}`;
            a.click();
        }
        exportAllBtn.disabled = false;
        exportAllBtn.innerHTML = btnText;
    }

    // --- Drag Logic ---
    function getMouse(e) {
        const rect = watermarkCanvas.getBoundingClientRect();
        return {
            x: (e.clientX - rect.left) * (watermarkCanvas.width / rect.width),
            y: (e.clientY - rect.top) * (watermarkCanvas.height / rect.height)
        };
    }

    function handleMouseDown(e) {
        if (!currentImage || e.button !== 0) return;
        
        watermark.isDragging = true;
        watermarkCanvas.classList.add('dragging');
        const pos = getMouse(e);
        watermark.dragStartX = pos.x;
        watermark.dragStartY = pos.y;
        watermark.initialX = watermark.x * watermarkCanvas.width;
        watermark.initialY = watermark.y * watermarkCanvas.height;
    }

    function handleMouseMove(e) {
        if (!watermark.isDragging) return;
        const pos = getMouse(e);
        watermark.x = (watermark.initialX + (pos.x - watermark.dragStartX)) / watermarkCanvas.width;
        watermark.y = (watermark.initialY + (pos.y - watermark.dragStartY)) / watermarkCanvas.height;
        updateUI();
        debounce(drawCanvas, 5)();
    }

    function handleMouseUp() {
        watermark.isDragging = false;
        watermarkCanvas.classList.remove('dragging');
    }

    // --- Events ---
    function initEvents() {
        imageUploadInput.onchange = handleImageUpload;
        deleteSelectedBtn.onclick = deleteSelectedImages;
        deselectAllBtn.onclick = deselectAllImages;
        
        watermarkTypeRadios.forEach(r => r.onchange = (e) => { 
            watermark.type = e.target.value; 
            updateUI(); 
            drawCanvas(); 
        });
        watermarkTextInput.oninput = (e) => { watermark.text = e.target.value; drawCanvas(); };
        fontSelect.onchange = (e) => { watermark.font = e.target.value; drawCanvas(); };
        fontSizeSlider.oninput = (e) => { watermark.fontSize = parseInt(e.target.value); updateUI(); drawCanvas(); };
        fontColorInput.oninput = (e) => { watermark.fontColor = e.target.value; drawCanvas(); };
        watermarkImageUploadInput.onchange = handleWatermarkImageUpload;
        
        tilingToggle.onchange = (e) => { watermark.isTiled = e.target.checked; updateUI(); drawCanvas(); };
        tileSpacingX.oninput = (e) => { watermark.tileSpacingX = parseInt(e.target.value); updateUI(); drawCanvas(); };
        tileSpacingY.oninput = (e) => { watermark.tileSpacingY = parseInt(e.target.value); updateUI(); drawCanvas(); };

        opacitySlider.oninput = (e) => { watermark.opacity = parseFloat(e.target.value); updateUI(); drawCanvas(); };
        sizeSlider.oninput = (e) => { watermark.scale = parseFloat(e.target.value); updateUI(); drawCanvas(); };
        rotationSlider.oninput = (e) => { watermark.rotation = parseInt(e.target.value); updateUI(); drawCanvas(); };
        positionXSlider.oninput = (e) => { watermark.x = e.target.value / 100; updateUI(); drawCanvas(); };
        positionYSlider.oninput = (e) => { watermark.y = e.target.value / 100; updateUI(); drawCanvas(); };

        savePresetBtn.onclick = () => {
            const name = prompt('预设名称:');
            if (name) {
                const s = JSON.parse(JSON.stringify(watermark));
                delete s.image;
                presets.push({ name, settings: s });
                localStorage.setItem(LOCAL_STORAGE_KEY_PRESETS, JSON.stringify(presets));
                renderPresetList();
            }
        };
        
        resetPositionBtn.onclick = () => {
            watermark.x = 0.5;
            watermark.y = 0.5;
            updateUI();
            drawCanvas();
        };

        exportAllBtn.onclick = exportAll;

        // 剪贴板粘贴支持
        window.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            const files = [];
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    files.push(items[i].getAsFile());
                }
            }
            if (files.length > 0) processFiles(files);
        });

        // 交互逻辑修改：未上传时单击上传，已上传时双击上传
        watermarkCanvas.onclick = (e) => {
            if (!currentImage) {
                imageUploadInput.click();
            }
        };

        watermarkCanvas.ondblclick = (e) => {
            if (currentImage) {
                imageUploadInput.click();
            }
        };

        watermarkCanvas.onmousedown = handleMouseDown;
        window.onmousemove = handleMouseMove;
        window.onmouseup = handleMouseUp;
        window.onresize = () => drawCanvas();
    }

    // --- Run ---
    (function init() {
        const storedPresets = localStorage.getItem(LOCAL_STORAGE_KEY_PRESETS);
        if (storedPresets) presets = JSON.parse(storedPresets);
        renderPresetList();
        loadSettings();
        initEvents();
        drawCanvas();
    })();
</script>
</body>
</html>
